<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>BLE PIR Delay Control</title>
</head>
<body>
  <h1>PIR OFF Delay Control</h1>
  <label for="delayRange">LED消灯遅延秒数（1〜60秒）: </label>
  <input type="range" id="delayRange" min="1" max="60" value="5" />
  <span id="delayValue">5</span> 秒

  <button id="connectBtn">BLE接続</button>

  <script>
    let device;
    let characteristic;
    const SERVICE_UUID = "3fb5626e-27b5-4cb9-b6ff-924b70f13215";
    const CHAR_UUID = "5dfaf517-f077-428d-b909-de9e321d1667";

    const delayRange = document.getElementById('delayRange');
    const delayValue = document.getElementById('delayValue');
    const connectBtn = document.getElementById('connectBtn');

    connectBtn.onclick = async () => {
      try {
        device = await navigator.bluetooth.requestDevice({
          filters: [{ services: [SERVICE_UUID] }]
        });
        const server = await device.gatt.connect();
        const service = await server.getPrimaryService(SERVICE_UUID);
        characteristic = await service.getCharacteristic(CHAR_UUID);
        alert("接続成功");
      } catch (error) {
        alert("接続失敗: " + error);
      }
    };

    delayRange.oninput = () => {
      delayValue.textContent = delayRange.value;
    };

    delayRange.onchange = async () => {
      if (!characteristic) {
        alert("まずBLEに接続してください");
        return;
      }
      const sec = delayRange.value;
      const command = `set_delay ${sec}`;
      console.log("Send command:", command);

      const encoder = new TextEncoder();
      const data = encoder.encode(command);

      try {
        await characteristic.writeValue(data);
        console.log("設定送信完了");
      } catch (error) {
        console.error("設定送信失敗:", error);
      }
    };
  </script>
</body>
</html>
